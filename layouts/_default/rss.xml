{{- /* Generate RSS v2 with full page content. */ -}}
{{- /* Upstream Hugo bug - RSS dates can be in future: https://github.com/gohugoio/hugo/issues/3918 */ -}}
{{- $pages := .Data.Pages -}}
{{- $limit := site.Config.Services.RSS.Limit -}}
{{- if ge $limit 1 -}}
  {{- $pages = $pages | first $limit -}}
{{- end -}}
{{- $author := site.GetPage (printf "/%s/%s" "authors" (.Scratch.Get "superuser_username")) -}}
{{- printf "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\" ?>" | safeHTML }}
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>{{ if ne .Title site.Title }}{{ with .Title }}{{.}} | {{ end }}{{end}}{{ site.Title }}</title>
    <link>{{ .Permalink }}</link>
    {{- with .OutputFormats.Get "HTML" }}
      {{ printf "<atom:link href=%q rel=\"alternate\" type=%q title=\"Website\" />" .Permalink .MediaType | safeHTML }}
    {{- end -}}
    {{- with .OutputFormats.Get "RSS" }}
      {{ printf "<atom:link href=%q rel=\"self\" type=%q title=\"Legacy Feed (RSS)\" />" .Permalink .MediaType | safeHTML }}
    {{- end }}
    {{- with .OutputFormats.Get "ATOM" }}
      {{ printf "<atom:link href=%q rel=\"alternate\" type=%q title=\"Modern Feed (Atom)\" />" .Permalink .MediaType | safeHTML }}
    {{- end }}
    {{ range .Translations }}
    {{- $lang := .Lang -}}
    {{- with .OutputFormats.Get "HTML" }}
      {{ printf "<atom:link href=%q rel=\"alternate\" type=%q hreflang=%q title=\"Website (in %s)\" />" .Permalink .MediaType $lang $lang | safeHTML }}
    {{- end -}}
    {{- with .OutputFormats.Get "RSS" }}
      {{ printf "<atom:link href=%q rel=\"alternate\" type=%q hreflang=%q title=\"Legacy Feed (RSS in %s)\" />" .Permalink .MediaType $lang $lang | safeHTML }}
    {{ end -}}
    {{- with .OutputFormats.Get "ATOM" }}
      {{ printf "<atom:link href=%q rel=\"alternate\" type=%q hreflang=%q title=\"Modern Feed (Atom in %s)\" />" .Permalink .MediaType $lang $lang | safeHTML }}
    {{- end -}}
    {{ end -}}
    <description>{{ .Title | default site.Title | html }} (RSS Legacy Feed)</description>
    <generator>Hugo v{{hugo.Version}} (https://gohugo.io/)</generator>
		{{ with $.Site.Author.email }}<managingEditor>{{ . | plainify }}</managingEditor>{{end}}
    {{- with site.LanguageCode }}<language>{{.}}</language>{{end -}}
    {{- with site.Copyright }}<copyright>{{ replace (replace . "{year}" now.Year) "&copy;" "Â©" | plainify }}</copyright>{{end -}}
    {{- if not .Date.IsZero }}<lastBuildDate>{{ .Date.Format "Mon, 02 Jan 2006 15:04:05 -0700" | safeHTML }}</lastBuildDate>{{ end -}}
    {{- if .Scratch.Get "og_image" }}
    <image>
      <url>{{ .Scratch.Get "og_image" }}</url>
      <title>{{ if ne .Title site.Title }}{{ with .Title }}{{.}} | {{ end }}{{end}}{{ site.Title }}</title>
      <link>{{ .Permalink }}</link>
    </image>
    {{end -}}
    {{ range $pages }}
    {{- if not .Params.DisableFeed }}{{ if ne .Section ""}}
    <item>
      {{ $uuid := sha1 .RelPermalink }}<guid isPermaLink="false">urn:uuid:{{substr $uuid 0 8}}-{{substr $uuid 8 4}}-5{{substr $uuid 13 3}}-{{substr $uuid 16 1}}9{{substr $uuid 17 2}}-{{substr $uuid 21 12}}</guid>
      <title>{{ .Title | plainify }}</title>
      <link>{{ .Permalink }}</link>
      <pubDate>{{ .Date.Format "Mon, 02 Jan 2006 15:04:05 -0700" | safeHTML }}</pubDate>
      {{ range .Params.categories }}
      <category>{{ . | html }}</category>
      {{ end }}
      <description>
        {{- printf "<![CDATA[" | safeHTML }}      
        {{- .Content | safeHTML | chomp -}}
        ]]>
      </description>
    </item>
    {{- end }}{{- end }}
    {{- end }}
  </channel>
</rss>
