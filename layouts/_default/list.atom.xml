{{- /* Generate Atom feed with full page content. */ -}}
{{- /* Upstream Hugo bug - Feed dates can be in future: https://github.com/gohugoio/hugo/issues/3918 */ -}}
{{- $pages := .Data.Pages -}}
{{- $limit := site.Config.Services.RSS.Limit -}}
{{- if ge $limit 1 -}}
  {{- $pages = $pages | first $limit -}}
{{- end -}}
{{- $author := site.GetPage (printf "/%s/%s" "authors" (.Scratch.Get "superuser_username")) -}}
{{- printf "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\" ?>" | safeHTML }}
<feed xmlns="http://www.w3.org/2005/Atom" xml:base="{{ site.BaseURL }}"{{- with site.LanguageCode }} xml:lang="{{.}}"{{end -}}>
  {{ $uuid := sha1 $.Site.BaseURL }}<id>urn:uuid:{{substr $uuid 0 8}}-{{substr $uuid 8 4}}-5{{substr $uuid 13 3}}-{{substr $uuid 16 1}}9{{substr $uuid 17 2}}-{{substr $uuid 21 12}}</id>
  <title type="text">{{ if ne .Title site.Title }}{{ with .Title }}{{.}} | {{ end }}{{end}}{{ site.Title }}</title>
  {{- with .Params.Subtitle }}<subtitle type="text">{{ . | plainify }}</subtitle>{{ end }}
  {{- with .OutputFormats.Get "HTML" }}
    {{ printf "<link href=%q rel=\"alternate\" type=%q />" .Permalink .MediaType | safeHTML }}
  {{- end -}}
  {{- with .OutputFormats.Get "ATOM" }}
    {{ printf "<link href=%q rel=\"self\" type=%q />" .Permalink .MediaType | safeHTML }}
  {{- end -}}
  {{- with .OutputFormats.Get "RSS" }}
    {{ printf "<link href=%q rel=\"alternate\" type=%q />" .Permalink .MediaType | safeHTML }}
  {{- end -}}
  {{ range .Translations }}
  {{- $lang := .Lang -}}
  {{- with .OutputFormats.Get "HTML" }}
    {{ printf "<link href=%q rel=\"alternate\" type=%q hreflang=%q />" .Permalink .MediaType $lang | safeHTML }}
  {{- end -}}
  {{- with .OutputFormats.Get "ATOM" }}
    {{ printf "<link href=%q rel=\"alternate\" type=%q hreflang=%q />" .Permalink .MediaType $lang | safeHTML }}
  {{- end -}}
  {{- with .OutputFormats.Get "RSS" }}
    {{ printf "<link href=%q rel=\"alternate\" type=%q hreflang=%q />" .Permalink .MediaType $lang | safeHTML }}
  {{ end -}}
  {{ end -}}
  <generator uri="https://gohugo.io/" version="{{.Hugo.Version}}">Hugo</generator>
  {{ with $author -}}
  <author>
    <name>{{ .Params.name }}</name>
    <uri>{{ .Permalink }}</uri>
  </author>
  {{ else -}}
  {{ with .Site.Author.name -}}
  <author>
		<name>{{.}}</name>
		{{ with $.Site.Author.email }}<email>{{.}}</email>{{end}}
	</author>{{end}}
  {{end -}}
  {{ with site.Copyright }}<rights>{{ replace (replace . "{year}" now.Year) "&copy;" "Â©" | plainify }}</rights>{{end }}
  {{ if not .Date.IsZero }}<updated>{{ .Date.UTC.Format "2006-01-02T15:04:05-07:00" | safeHTML }}</updated>{{ end }}
  {{ if .Scratch.Get "og_image" }}<logo>{{ .Scratch.Get "og_image" }}</logo>{{end -}}
  {{- $start := now.AddDate -1 0 0}}
  {{- range $pages }}
  {{- if not .Params.DisableFeed }}{{ if ne .Section ""}}
  <entry>
    {{ $uuid := sha1 .Permalink }}<id>urn:uuid:{{substr $uuid 0 8}}-{{substr $uuid 8 4}}-5{{substr $uuid 13 3}}-{{substr $uuid 16 1}}9{{substr $uuid 17 2}}-{{substr $uuid 21 12}}</id>
    <title type="text">{{ .Title | plainify }}</title>
    <category term="{{.Section}}" label="{{.Section}}" />
    {{ with .Params.Subtitle }}<subtitle type="text">{{ . | plainify }}</subtitle>{{ end }}
    {{ if not .Lastmod.IsZero }}<updated>{{ .Lastmod.Format "2006-01-02T15:04:05-07:00" | safeHTML }}</updated>{{ end }}
    <published>{{ .Date.Format "2006-01-02T15:04:05-07:00" | safeHTML }}</published>
    <link href="{{ .Permalink }}?utm_source=atom_feed" rel="alternate" type="text/html" />
    {{- range .Translations }}
    {{- $link := printf "%s?utm_source=atom_feed" .Permalink | safeHTML }}
    {{ printf "<link href=%q rel=\"alternate\" type=\"text/html\" hreflang=%q />" $link .Lang | safeHTML }}
    {{ end -}}
    {{ with .Summary }}{{ if ne . "" }}
    <summary type"="html"">
      {{- printf "<![CDATA[" | safeHTML }}      
      {{ . | safeHTML | chomp }}
      ]]>
    </summary>
    {{ end }}{{ end }}
    <content type="html">
      {{- printf "<![CDATA[" | safeHTML }}      
      {{- .Content | safeHTML | chomp -}}
      ]]>
    </content>
  </entry>
  {{- end }}{{- end }}
  {{- end }}
</feed>
