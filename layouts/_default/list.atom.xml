{{- /* Generate Atom feed with full page content. */ -}}
{{- /* Upstream Hugo bug - Feed dates can be in future: https://github.com/gohugoio/hugo/issues/3918 */ -}}
{{- $pages := .Data.Pages -}}
{{- $limit := site.Config.Services.RSS.Limit -}}
{{- if ge $limit 1 -}}
  {{- $pages = $pages | first $limit -}}
{{- end -}}
{{- $author := site.GetPage (printf "/%s/%s" "authors" (.Scratch.Get "superuser_username")) -}}
{{- printf "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\" ?>" | safeHTML }}
<feed xmlns="http://www.w3.org/2005/Atom"{{- with site.LanguageCode }} xml:lang="{{.}}"{{end -}}>
  {{ $uuid := sha1 $.Site.BaseURL }}<id>urn:uuid:{{substr $uuid 0 8}}-{{substr $uuid 8 4}}-5{{substr $uuid 13 3}}-{{substr $uuid 16 1}}9{{substr $uuid 17 2}}-{{substr $uuid 21 12}}</id>
  <title type="html">{{ if ne .Title site.Title }}{{ with .Title }}{{. | html }} | {{ end }}{{end}}{{ site.Title | html }}{{ if .IsTranslated }} ({{ index site.Data.i18n.languages .Lang }}){{ end }}</title>
  {{- if (.Params.Subtitle) and (ne .Params.Subtitle "") }}<subtitle type="html">{{ .Params.Subtitle | html }}</subtitle>
  {{- else if ($.Site.Params.Subtitle) and (ne $.Site.Params.Subtitle "") }}<subtitle type="html">{{ $.Site.Params.Subtitle | html }}</subtitle>{{ end }}
  {{- with .OutputFormats.Get "HTML" }}
    {{ printf "<link href=%q rel=\"alternate\" type=%q title=\"Website\" />" .Permalink .MediaType | safeHTML }}
  {{- end -}}
  {{- with .OutputFormats.Get "ATOM" }}
    {{ printf "<link href=%q rel=\"self\" type=%q title=\"Modern Feed (Atom)\" />" .Permalink .MediaType | safeHTML }}
  {{- end -}}
  {{- with .OutputFormats.Get "RSS" }}
    {{ printf "<link href=%q rel=\"alternate\" type=%q title=\"Legacy Feed (RSS)\" />" .Permalink .MediaType | safeHTML }}
  {{- end -}}
  {{ range .Translations }}
  {{- $lang := .Lang -}}
  {{- $langstr := index site.Data.i18n.languages .Lang -}}
  {{- with .OutputFormats.Get "HTML" }}
    {{ printf "<link href=%q rel=\"alternate\" type=%q hreflang=%q title=\"Website (%s)\" />" .Permalink .MediaType $lang $langstr | safeHTML }}
  {{- end -}}
  {{- with .OutputFormats.Get "ATOM" }}
    {{ printf "<link href=%q rel=\"alternate\" type=%q hreflang=%q title=\"Modern Feed (Atom, %s)\" />" .Permalink .MediaType $lang $langstr | safeHTML }}
  {{- end -}}
  {{- with .OutputFormats.Get "RSS" }}
    {{ printf "<link href=%q rel=\"alternate\" type=%q hreflang=%q title=\"Legacy Feed (RSS, %s)\" />" .Permalink .MediaType $lang $langstr | safeHTML }}
  {{ end -}}
  {{ end -}}
  {{ if and (eq site.Params.comments.engine 1) (site.Params.comments.disqus.shortname) }}
  <link href="https://{{ site.Params.comments.disqus.shortname }}.disqus.com/comments.rss" rel="comments" type="application/rss+xml" title="Comments" />
  {{ end }}
  <generator uri="https://gohugo.io/" version="{{hugo.Version}}">Hugo @ Source Themes Academic (https://sourcethemes.com/academic/)</generator>
  {{ with $author -}}
  <author>
    <name>{{ .Params.name }}</name>
    <uri>{{ .Permalink }}</uri>
    {{ with .Params.email }}<email>{{ . | plainify }}</email>{{end}}
  </author>
  {{ else -}}
  {{ with .Site.Author.name -}}
  <author>
		<name>{{ . | plainify }}</name>
		{{ with $.Site.Author.email }}<email>{{ . | plainify }}</email>{{end}}
	</author>{{end}}
  {{end -}}
  {{ with site.Copyright }}<rights>{{ replace (replace . "{year}" now.Year) "&copy;" "Â©" | plainify }}</rights>{{end }}
  {{ if not .Date.IsZero }}<updated>{{ .Date.UTC.Format "2006-01-02T15:04:05-07:00" | plainify  }}</updated>{{ end }}
  <icon>{{ site.BaseURL }}img/icon-32.png</icon>
  <logo>{{ site.BaseURL }}img/icon-512.png</logo>
  {{- $start := now.AddDate -1 0 0}}
  {{- range $pages }}
  {{- if not .Params.DisableFeed }}{{ if ne .Section ""}}
  <entry>
    {{ $uuid := sha1 .RelPermalink }}<id>urn:uuid:{{substr $uuid 0 8}}-{{substr $uuid 8 4}}-5{{substr $uuid 13 3}}-{{substr $uuid 16 1}}9{{substr $uuid 17 2}}-{{substr $uuid 21 12}}</id>
    <title type="html">{{ .Title | html }}</title>
    {{ if not .Lastmod.IsZero }}<updated>{{ .Lastmod.Format "2006-01-02T15:04:05-07:00" | safeHTML }}</updated>{{ end }}
    <published>{{ .Date.Format "2006-01-02T15:04:05-07:00" | safeHTML }}</published>
    <link href="{{ .Permalink }}?utm_source=atom_feed" rel="alternate" type="text/html" />
    {{- range .Translations }}
    {{- $link := printf "%s?utm_source=atom_feed" .Permalink | safeHTML }}
    {{ printf "<link href=%q rel=\"alternate\" type=\"text/html\" hreflang=%q />" $link .Lang | safeHTML }}
    {{ end -}}
    {{ range .Params.categories }}
    <category term="{{ . }}" label="{{ . | html }}" />
    {{ end }}
    {{ if .Summary }}{{ if ne .Summary "" }}
    <summary type="html">
      {{- printf "<![CDATA[" | safeHTML }}
      {{ .Summary | safeHTML | chomp }}
      ]]>
    </summary>
    {{- end }}{{- end }}
    <content type="html" xml:base="{{ site.BaseURL }}">
      {{- printf "<![CDATA[" | safeHTML }}
      {{- .Content | safeHTML | chomp -}}
      ]]>
    </content>
    {{ if site.Params.comments.engine | and (index site.Params.comments.commentable .Type) | and (ne .Params.commentable false) | or .Params.commentable }}
    <link href="{{ .Permalink }}?utm_source=atom_feed#comments" rel="service.post" type="text/html" title="Add your comment" />
    {{ end }}
    {{ if ne .Type "page" }}
      {{ $related := site.RegularPages.Related . | first 5 }}
      {{ with $related }}
          {{ range . }}
          <link href="{{ .Permalink }}?utm_source=atom_feed" rel="related" type="text/html" title="{{ .Title }}" />
          {{ end }}
      {{ end }}
    {{ end }}
  </entry>
  {{- end }}{{- end }}
  {{- end }}
</feed>
