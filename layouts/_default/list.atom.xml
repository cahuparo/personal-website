{{- /* Generate Atom feed with full page content. */ -}}
{{- /* Upstream Hugo bug - Feed dates can be in future: https://github.com/gohugoio/hugo/issues/3918 */ -}}
{{- $pages := .Data.Pages -}}
{{- $limit := site.Config.Services.RSS.Limit -}}
{{- if ge $limit 1 -}}
  {{- $pages = $pages | first $limit -}}
{{- end -}}
{{- $author := site.GetPage (printf "/%s/%s" "authors" (.Scratch.Get "superuser_username")) -}}
{{- printf "<?xml version=\"1.0\" encoding=\"utf-8\" ?>" | safeHTML }}
<feed xmlns="http://www.w3.org/2005/Atom" xml:base="{{ site.BaseURL }}"{{- with site.LanguageCode }} xml:lang="{{.}}"{{end -}}>
  <id>{{ .Permalink }}</id>
  <title type="text">{{ if ne .Title site.Title }}{{ with .Title }}{{.}} | {{ end }}{{end}}{{ site.Title }}</title>
  {{- with .OutputFormats.Get "HTML" }}
    {{ printf "<link href=%q rel=\"alternate\" type=%q />" .Permalink .MediaType | safeHTML }}
  {{- end -}}
  {{- with .OutputFormats.Get "ATOM" }}
    {{ printf "<link href=%q rel=\"self\" type=%q />" .Permalink .MediaType | safeHTML }}
  {{- end -}}
  {{- with .OutputFormats.Get "RSS" }}
    {{ printf "<link href=%q rel=\"alternate\" type=%q />" .Permalink .MediaType | safeHTML }}
  {{- end -}}
  {{ range .Translations }}
  {{- $lang := .Lang -}}
  {{- with .OutputFormats.Get "HTML" }}
    {{ printf "<link href=%q rel=\"alternate\" type=%q hreflang=%q />" .Permalink .MediaType $lang | safeHTML }}
  {{- end -}}
  {{- with .OutputFormats.Get "ATOM" }}
    {{ printf "<link href=%q rel=\"alternate\" type=%q hreflang=%q />" .Permalink .MediaType $lang | safeHTML }}
  {{- end -}}
  {{- with .OutputFormats.Get "RSS" }}
    {{ printf "<link href=%q rel=\"alternate\" type=%q hreflang=%q />" .Permalink .MediaType $lang | safeHTML }}
  {{ end -}}
  {{ end -}}
  <generator>Source Themes Academic (https://sourcethemes.com/academic/)</generator>
  {{ with $author -}}
  <author>
    <name>{{ .Params.name }}</name>
    <uri>{{ .Permalink }}</uri>
  </author>
  {{end -}}
  {{ with site.Copyright }}<rights>{{ replace (replace . "{year}" now.Year) "&copy;" "Â©" | plainify }}</rights>{{end }}
  {{ if not .Date.IsZero }}<updated>{{ .Date.Format "2006-01-02T15:04:05-07:00" | safeHTML }}</updated>{{ end }}
  {{ if .Scratch.Get "og_image" }}<logo>{{ .Scratch.Get "og_image" }}</logo>{{end -}}
  {{ range $pages }}{{ if not .Params.DisableRSS }}
  <entry>
    <id>{{ .Permalink }}</id>
    <title type="text">{{ .Title | plainify }}</title>
    {{ with .Params.Subtitle }}<subtitle type="text">{{ . | plainify }}</subtitle>{{ end }}
    {{ if not .Lastmod.IsZero }}<updated>{{ .Lastmod.Format "2006-01-02T15:04:05-07:00" | safeHTML }}</updated>{{ end }}
    <published>{{ .Date.Format "2006-01-02T15:04:05-07:00" | safeHTML }}</published>
    <link href="{{ .Permalink }}?utm_source=atom_feed" />
    {{ with .Summary }}<summary type="html">{{ . | safeHTML }}</summary>{{ end }}
    <content type="html">
      {{- printf "<![CDATA[" | safeHTML }}      
      {{- .Content | safeHTML -}}
      ]]>
    </content>
  </entry>
  {{ end }}{{ end }}
</feed>
